<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Sensores</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#0f172a; color:white; font-family:Arial; padding:20px; }
.card { background:#1e293b; padding:15px; margin:10px 0; border-radius:8px; }

.modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  display: none; justify-content: center; align-items: center;
  backdrop-filter: blur(4px);
}

.modal-content {
  padding:20px; border-radius:10px; text-align:center; font-size:22px; color:white;
  width: 300px;
}

/* Colores */
.modal-green { background:#16a34a; }   /* verde */
.modal-orange { background:#ea580c; }  /* naranja */
.modal-red { background:#dc2626; }     /* rojo */
.modal-blue { background:#0095ff; }     /* azul */

button { margin-top:10px; padding:8px 16px; font-weight:bold; cursor:pointer; border:none; border-radius:6px; }
</style>
</head>

<body>
<h2>Panel ESP32 ‚Äì Node + Express + EJS + MODAL</h2>

<div class="card">
  <h3>üå°Ô∏è Temperatura: <span id="t">--</span> ¬∞C</h3>
  <h3>üíß Humedad: <span id="h">--</span> %</h3>
</div>

<div class="card">
  <h3>üìè Distancia: <span id="d">--</span> cm</h3>
</div>

<div class="card">
  <canvas id="grafico"></canvas>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div id="modal-box" class="modal-content">
      <span id="modal-msg"></span><br>
      <button onclick="closeModal()">Cerrar</button>
  </div>
</div>

<script>
let ctx = document.getElementById("grafico");
let chart = new Chart(ctx, {
    type: "line",
    data: { labels: [], datasets: [
        { label: "Temp ¬∞C", data: [], borderWidth: 2 },
        { label: "Humedad %", data: [], borderWidth: 2 },
        { label: "Distancia cm", data: [], borderWidth: 2 }
    ]}
});

function closeModal(){ document.getElementById("modal").style.display = "none"; }

async function tick(){
  let r = await fetch('/latest');
  let data = await r.json();
  if(!data.temperature) return;

  document.getElementById('t').textContent = data.temperature;
  document.getElementById('h').textContent = data.humidity;
  document.getElementById('d').textContent = data.distance;

  chart.data.labels.push("");
  chart.data.datasets[0].data.push(data.temperature);
  chart.data.datasets[1].data.push(data.humidity);
  chart.data.datasets[2].data.push(data.distance);
  chart.update();

  // Mostrar modal seg√∫n distancia
  const modal = document.getElementById("modal");
  const box = document.getElementById("modal-box");
  const msg = document.getElementById("modal-msg");

  let dist = data.distance;
  if(dist <= 5){
    box.className = "modal-content modal-blue";
    msg.textContent = `‚òÅÔ∏èüå§Ô∏è Felicitaciones estas en el Cielo, te lo adverti sapa  (${dist.toFixed(2)} cm)`;
    modal.style.display = "flex";
  } 
  else if(dist <= 10){
    box.className = "modal-content modal-red";
    msg.textContent = `üö® SAPO PRRO √öLTIMA ADVERTENCIA (${dist.toFixed(2)} cm)`;
    modal.style.display = "flex";
  } 
  else if(dist <= 15){
    box.className = "modal-content modal-orange";
    msg.textContent = `‚ö†Ô∏è Pilas prro, se est√° acercando mucho y no me esta gustando (${dist.toFixed(2)} cm)`;
    modal.style.display = "flex";
  }
  else if(dist <= 20){
    box.className = "modal-content modal-green";
    msg.textContent = `üü¢ Se est√° aproximando sapa prra pilas... (${dist.toFixed(2)} cm)`;
    modal.style.display = "flex";
  }else{
    closeModal();
  }
}
setInterval(tick, 1000);
</script>
</body>
</html>

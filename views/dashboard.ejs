<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Sensores</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#0f172a; color:white; font-family:Arial; padding:20px; }
.card { background:#1e293b; padding:15px; margin:10px 0; border-radius:8px; }

.modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  display: none; justify-content: center; align-items: center;
  backdrop-filter: blur(4px);
}

.modal-content {
  padding:20px; border-radius:10px; text-align:center; font-size:22px; color:white;
  width: 300px;
}

/* Colores */
.modal-green { background:#16a34a; }   /* verde */
.modal-orange { background:#ea580c; }  /* naranja */
.modal-red { background:#dc2626; }     /* rojo */
.modal-blue { background:#0095ff; }     /* azul */

button { margin-top:10px; padding:8px 16px; font-weight:bold; cursor:pointer; border:none; border-radius:6px; }
button { padding:8px 16px; margin-right:5px; }
.tab { animation: fade .3s; }
@keyframes fade { from{opacity:.3;} to{opacity:1;} }

</style>
</head>

<body>
<h2>Panel ESP32 ‚Äì Node + Express + EJS + MODAL</h2>

<!-- TABS -->
<div style="margin-bottom:15px;">
  <button onclick="showTab('tab1')">Sensor Ambiente</button>
  <button onclick="showTab('tab2')">Sensor Fuego / RPM</button>
</div>

<!-- TAB 1: Sensor ambiente (tu dashboard actual) -->
<div id="tab1" class="tab active">

  <div class="card">
    <h3>üå°Ô∏è Temperatura: <span id="t">--</span> ¬∞C</h3>
    <h3>üíß Humedad: <span id="h">--</span> %</h3>
  </div>

  <div class="card">
    <h3>üìè Distancia: <span id="d">--</span> cm</h3>
  </div>

  <div class="card">
    <canvas id="grafico"></canvas>
  </div>

</div>

<!-- TAB 2: Nuevo m√≥dulo fuego y RPM -->
<div id="tab2" class="tab" style="display:none;">

  <div class="card">
    <h3>üî• Sensor de Fuego: <span id="flame">--</span></h3>
  </div>

  <div class="card">
    <h3‚öôÔ∏è>RPM: <span id="rpm">--</span></h3>
  </div>

</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div id="modal-box" class="modal-content">
      <span id="modal-msg"></span><br>
      <button onclick="closeModal()">Cerrar</button>
  </div>
</div>

<script>
    function showTab(tab){
        document.getElementById("tab1").style.display = "none";
        document.getElementById("tab2").style.display = "none";
        document.getElementById(tab).style.display = "block";
    }
let ctx = document.getElementById("grafico");
let chart = new Chart(ctx, {
    type: "line",
    data: { labels: [], datasets: [
        { label: "Temp ¬∞C", data: [], borderWidth: 2 },
        { label: "Humedad %", data: [], borderWidth: 2 },
        { label: "Distancia cm", data: [], borderWidth: 2 }
    ]}
});

function closeModal(){ document.getElementById("modal").style.display = "none"; }

async function tick(){
  let r = await fetch('/latest');
  let data = await r.json();
  // Si vienen datos del ESP #1 (ambiente)
  if(data.temperature !== undefined){
    document.getElementById('t').textContent = data.temperature;
    document.getElementById('h').textContent = data.humidity;
    document.getElementById('d').textContent = data.distance;

    chart.data.labels.push("");
    chart.data.datasets[0].data.push(data.temperature);
    chart.data.datasets[1].data.push(data.humidity);
    chart.data.datasets[2].data.push(data.distance);
    chart.update();

    // Mostrar modal seg√∫n distancia
    const modal = document.getElementById("modal");
    const box = document.getElementById("modal-box");
    const msg = document.getElementById("modal-msg");

    let dist = data.distance;
    if(dist <= 5){
      box.className = "modal-content modal-blue";
      msg.textContent = `‚òÅÔ∏èüå§Ô∏è Felicitaciones estas en el Cielo (${dist.toFixed(2)} cm)`;
      modal.style.display = "flex";
    } else if(dist <= 10){
      box.className = "modal-content modal-red";
      msg.textContent = `üö® Ultima advertencia (${dist.toFixed(2)} cm)`;
      modal.style.display = "flex";
    } else if(dist <= 15){
      box.className = "modal-content modal-orange";
      msg.textContent = `‚ö†Ô∏è Pilas bro (${dist.toFixed(2)} cm)`;
      modal.style.display = "flex";
    } else if(dist <= 20){
      box.className = "modal-content modal-green";
      msg.textContent = `üü¢ Se est√° aproximando (${dist.toFixed(2)} cm)`;
      modal.style.display = "flex";
    } else {
      closeModal();
    }
  }

  // Si vienen datos del ESP #2 (flame + rpm)
  if(data.type === "multi"){
    document.getElementById("flame").textContent = data.flame === 0 ? "üî• Fuego detectado" : "‚úÖ No detecta fuego";
    document.getElementById("rpm").textContent = data.rpm;
  }
}
setInterval(tick, 1000);
</script>
</body>
</html>
